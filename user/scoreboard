#!/bin/sh

### SCOREBOARD ###
cat /scoreboard/score.board > /scoreboard/score.board.bak

# Create a scoreboard file if it doesn't exist
if [ ! -f /scoreboard/score.board ]; then
    touch /scoreboard/score.board
fi

CLVL=1
FAIL=0

if [ -f ../result/1 ]; then
    grep -q "[OK]" ../result/1
    if [ $? -eq 0 ]; then
        CLVL=2
    else
        FAIL=1
    fi
fi

if [ -f ../result/2 && $FAIL -eq 0 ]; then
    grep -q "[OK]" ../result/2
    if [ $? -eq 0 ]; then
        CLVL=3
    else
        FAIL=1
    fi
fi

if [ -f ../result/3 && $FAIL -eq 0 ]; then
    grep -q "[OK]" ../result/3
    if [ $? -eq 0 ]; then
        CLVL=4
    else
        FAIL=1
    fi
fi

# Prompt user from tmux to enter their name
if [ $FAIL -eq 0 ]; then
    tmux popup -t kodmaschine:0 -h 40% -w 40% -x 10% -y 10% 'figlet Exam challenger && echo "Login name: " && read name && echo $name > /scoreboard/new_entry'
    tmux send-keys -t kodmaschine:2 'killall vim' C-m
    sleep 0.042
    tmux send-keys -t kodmaschine:2 "vim challenge$CLVL.c" C-m
else
    tmux popup -t kodmaschine:0 -h 40% -w 40% -x 10% -y 10% "echo $CLVL; cat /result/$CLVL | figlet -t -c; echo -e '\n\nPress ESC to close this window.'"
    exit 1
fi

# Wait for user to enter their name
while [ ! -s /scoreboard/new_entry ]; do
    sleep 0.5
done

# Read the user's name
name=$(cat /scoreboard/new_entry)

# Get current user time
time=$(cat /scoreboard/current_user_time)

# Add user to scoreboard
echo "$CLVL $time $name" >> /scoreboard/score.board

# Sort scoreboard
sort -k1,1nr -k2,2n -k3,3n /scoreboard/score.board | tee /scoreboard/score.board

if [ -s /scoreboard/score.board -eq 1]; then
    cat /scoreboard/score.board.bak > /scoreboard/score.board
fi